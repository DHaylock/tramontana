window.BFt={},BFt.state="INIT",BFt.changedStateInCycle=0,BFt.changeState=function(a){a!=BFt.state&&(BFt.state=a,BFt.changedStateInCycle=1,jQuery.event.trigger("stateChanged",{}))},window.onbeforeunload=function(){for(var a in BFt)BFt[a].socket.close(16,"page closing")},window.BFtObject=function(){var a=new Object;return a.socket=new Object,a.status="INIT",a.subscribed={distance:0,orientation:0,attitude:0,magnetometer:0,touch:0,audiojack:0,powersource:0,rxembedded:0},a.callbacks={videoended:0,socketopen:0,distance:0,orientation:0,attitude:0,magnetometer:0,touch:0,audiojack:0,powersource:0,rxembedded:0},a.subscribeFunctions={distance:0,orientation:0,attitude:0,magnetometer:0,touch:0,audiojack:0,powersource:0,rxembedded:0},a.setupSocket=a.start=function(b,c){if(""==b)return void(b="192.168.1.:9092");b.indexOf(":")==-1&&(b+=":9092"),"Firefox"==BrowserDetect.browser?console.error("Websocket not supported. Please use Safari or Chrome."):a.socket=new ReconnectingWebSocket(get_appropriate_ws_url(b)),void 0!=c&&(a.callbacks.socketopen=c);try{a.socket.onopen=function(){a.status="OPEN",jQuery.event.trigger("socketOpened",[]),a.retrial=0;for(var b in a.subscribed)a.subscribed[b]&&a.subscribeFunctions[b]();0!=a.callbacks.socketopen&&a.callbacks.socketopen();try{socketOpened()}catch(a){}},a.socket.onmessage=function(c){try{messageObject=JSON.parse(c.data)}catch(a){console.warn("error loading JSON",c,a)}var d=a.socket.url.replace(a.socket.url.slice(-5),"");if(d=d.slice(5),"x"==messageObject.m||"xm"==messageObject.m||"xt"==messageObject.m)return void jQuery.event.trigger("ping",{address:d,type:messageObject.m});if(console.info('::: ----> received:"'+messageObject.m+'"',messageObject),"touched"!=messageObject.m)if("a"==messageObject.m)jQuery.event.trigger("a",{address:d,r:messageObject.r,y:messageObject.y,p:messageObject.p}),0!=a.callbacks.attitude&&a.callbacks.attitude(d,{r:messageObject.r,y:messageObject.y,p:messageObject.p});else if("oom"==messageObject.m)jQuery.event.trigger("oom",{address:d});else if("rx"==messageObject.m)jQuery.event.trigger("receivedRx",{address:d,v:messageObject.v}),0!=a.callbacks.rxembedded&&a.callbacks.rxembedded(d,messageObject.v);else if("orientationChanged"==messageObject.m){a.orientation=messageObject.value,0!=a.callbacks.orientation&&a.callbacks.orientation(d,a.orientation);try{orientationChanged(d,a.orientation)}catch(a){}jQuery.event.trigger("orientationChanged",{address:d,value:messageObject.value})}else if("magnetometerUpdate"==messageObject.m){a.magnetometer=messageObject.t,a.magnetometerIntensity=messageObject.i,0!=a.callbacks.magnetometer&&a.callbacks.magnetometer(d,a.magnetometer,a.magnetometerIntensity);try{magnetometerEvent(d,a.magnetometer,a.magnetometerIntensity)}catch(a){}jQuery.event.trigger("magnetometerEvent",{address:d,i:messageObject.i,t:messageObject.t})}else if("distanceChanged"==messageObject.m){a.proximity=messageObject.proximity,0!=a.callbacks.distance&&a.callbacks.distance(d,a.proximity);try{distanceChanged(d,a.proximity)}catch(a){}jQuery.event.trigger("distanceChanged",{address:d,p:messageObject.proximity})}else if("audioJackChanged"==messageObject.m){a.audiojack=messageObject.in,0!=a.callbacks.audiojack&&a.callbacks.audiojack(d,a.audiojack);try{audioJackChanged(d,a.audiojack)}catch(a){}jQuery.event.trigger("audioJackChanged",{address:d,in:messageObject.in})}else if("powerSourceChanged"==messageObject.m){a.powersource=messageObject.source,0!=a.callbacks.powersource&&a.callbacks.powersource(d,a.powersource);try{powerSourceChanged(d,a.powersource)}catch(a){}jQuery.event.trigger("powerSourceChanged",{address:d,in:messageObject.source})}else if("batteryGet"==messageObject.m){a.batteryLevel=messageObject.value;try{gotBatteryLevel(messageObject.value)}catch(a){}jQuery.event.trigger("gotBatteryLevel",{address:d,batteryLevel:messageObject.value})}else if("videoEnded"==messageObject.m){0!=a.callbacks.videoended&&a.callbacks.videoended(d);try{videoEnded()}catch(a){}jQuery.event.trigger("videoEnded",{address:d})}else"error"==messageObject.m?console.warn(messageObject.type):"test"==messageObject.m&&console.log(Date.now());else{0!=messageObject.value&&"0"!=messageObject.value||(a.touched=!1),0!=a.callbacks.touched?a.callbacks.touched(d,{x:messageObject.x,y:messageObject.y}):(a.touched=!0,jQuery.event.trigger("touched",{address:d,x:messageObject.x,y:messageObject.y}));try{touched(d,messageObject.x,messageObject.y)}catch(a){}}},a.socket.onclose=function(){a.status="CLOSED",console.warn("connection: %s",a.status,a.socket)},a.socket.onerror=function(){a.status="ERROR"}}catch(b){alert("<p>Error"+b),a.status="ERROR"}},a.setServoEmbedded=function(a,b){2==arguments.length&&this.sendMessage('{"m":"srv","n":'+a+',"v":'+b+"}")},a.setRelayEmbedded=function(a,b){2==arguments.length&&this.sendMessage('{"m":"rel","n":'+a+',"v":'+Math.round(b)+"}")},a.sendSerialMessageEmbedded=function(a){1==arguments.length&&this.sendMessage('{"m":"tx","v":"'+a+'"}')},a.setColorEmbedded=function(a,b,c,d,e){5!=arguments.length&&4!=arguments.length||this.sendMessage('{"m":"col","n":"'+a+'","r":"'+Math.floor(b)+'","g":"'+Math.floor(c)+'","b":"'+Math.floor(d)+'"}')},a.blinkColorEmbedded=function(a,b,c,d,e){4==arguments.length&&this.sendMessage('{"m":"blk","n":"'+a+'","r":"'+Math.floor(b)+'","g":"'+Math.floor(c)+'","b":"'+Math.floor(d)+'"}')},a.setAllColorEmbedded=function(a,b,c,d){4==arguments.length&&this.sendMessage('{"m":"all","r":"'+Math.floor(a)+'","g":"'+Math.floor(b)+'","b":"'+Math.floor(c)+'"}')},a.setColor=function(a,b,c,d){if(4==arguments.length&&((a>1||b>1||c>1)&&(a/=255,b/=255,c/=255,d/=255),this.sendMessage('{"m":"setColor","r":"'+a+'","g":"'+b+'","b":"'+c+'","a":"'+d+'"}')),1==arguments.length&&arguments[0].hasOwnProperty(r)){var e=a;(e.r>1||e.g>1||e.b>1)&&(e.r=e.r/255,e.g=e.g/255,e.b=e.b/255,e.a=e.a/255),this.sendMessage('{"m":"setColor","r":"'+e.r+'","g":"'+e.g+'","b":"'+e.b+'","a":"'+e.a+'"}')}},a.setFlashLight=function(a){a=clamp(a,0,a),this.sendMessage('{"m":"setLED","value":"1","in":"'+a+'"}')},a.pulseFlashLight=function(a,b,c){3==arguments.length?this.sendMessage('{"m":"pulseLED","t":"'+a+'","d":"'+b+'","i":"'+c+'"}'):console.warn("pulseLED requires 3 inputs: numberOfPulses,duration,intensity")},a.showImage=function(a){"string"==typeof a?this.sendMessage('{"m":"showImage","url":"'+a+'"}'):console.warn("showImage requires a string input")},a.playVideo=function(b,c){void 0!=c?a.callbacks.videoended=c:a.callbacks.videoended=0,"string"==typeof b?this.sendMessage('{"m":"playVideo","url":"'+b+'"}'):console.warn("playVideo requires a string input")},a.playAudio=function(a){"string"==typeof a?this.sendMessage('{"m":"playAudio","url":"'+a+'"}'):console.warn("playAudio requires a string input")},a.setBrightness=function(a){isNumber(a)?this.sendMessage('{"m":"setBrightness","b":"'+a+'"}'):console.warn("setBrighness requires one numerical parameter")},a.takePicture=function(a,b){if(arguments.length>0&&isNumber(a)){var c='{"m":"takePicture","c":"'+a+'"';arguments.length>1&&"ui"==b&&(c+=',"i":"ui"'),c+="}",this.sendMessage(c)}else this.sendMessage('{"m":"takePicture"}')},a.transitionColors=function(a,b,c){3==arguments.length?(isNumber(c)||(c=5,console.warn("transitionColors: duration is not a number")),this.sendMessage('{"m":"transitionColors","r1":"'+a.r+'","g1":"'+a.b+'","b1":"'+a.g+'","a1":"'+a.a+'","r2":"'+b.r+'","g2":"'+b.g+'","b2":"'+b.b+'","a2":"'+b.a+'","duration":"'+c+'"}')):console.warn("transitionColors requires 3 parameters: color1,color2,duration")},a.getBatteryLevel=function(){var b='{"m":"getBattery"}';a.sendMessage(b)},a.subscribeFunctions.distance=a.subscribeDistance=function(b){a.subscribed.distance=1,a.sendMessage('{"m":"registerDistance"}'),void 0!=b?a.callbacks.distance=b:a.callbacks.distance=0},a.releaseDistance=function(){a.subscribed.distance=0,a.sendMessage('{"m":"releaseDistance"}')},a.subscribeFunctions.touch=a.subscribeTouch=function(b){a.subscribed.touch=1,a.sendMessage('{"m":"registerTouch"}'),void 0!=b?a.callbacks.touch=b:a.callbacks.touch=0},a.releaseTouch=function(){a.subscribed.touch=0,a.sendMessage('{"m":"releaseTouch"}')},a.subscribeFunctions.attitude=a.subscribeAttitude=function(b,c){a.subscribed.attitude=1,a.sendMessage('{"m":"registerAttitude","f":"'+b+'"}'),void 0!=c?a.callbacks.attitude=c:a.callbacks.attitude=0},a.releaseAttitude=function(b){a.subscribed.attitude=0,a.sendMessage('{"m":"releaseAttitude"}')},a.subscribeFunctions.audiojack=a.subscribeAudioJack=function(b){a.subscribed.audiojack=1,a.sendMessage('{"m":"registerAudioJack"}'),void 0!=b?a.callbacks.audiojack=b:a.callbacks.audiojack=0},a.releaseAudioJack(),a.subscribed.audiojack=0,a.sendMessage('{"m":"releaseAudioJack"}'),a.subscribeFunctions.powersource=a.subscribePowerSource=function(b){a.subscribed.powersource=1,a.sendMessage('{"m":"registerPowerSource"}'),void 0!=b?a.callbacks.powersource=b:a.callbacks.powersource=0},a.releasePowerSource(),a.subscribed.powersource=0,a.sendMessage('{"m":"releasePowerSource"}'),a.subscribeFunctions.magnetometer=a.subscribeMagnetometer=function(b){a.subscribed.magnetometer=1,a.sendMessage('{"m":"registerMagnetometer"}'),void 0!=b?a.callbacks.magnetometer=b:a.callbacks.magnetometer=0},a.releaseMagnetometer=function(){a.subscribed.magnetometer=0,a.sendMessage('{"m":"releaseMagnetometer"}')},a.subscribeFunctions.orientation=a.subscribeOrientation=function(b){a.subscribed.orientation=1;var c='{"m":"registerOrientation"}';a.sendMessage(c),void 0!=b?a.callbacks.orientation=b:a.callbacks.orientation=0},a.releaseOrientation=function(){var b='{"m":"releaseOrientation"}';a.subscribed.orientation=0,a.sendMessage(b)},a.subscribeFunctions.rxembedded=a.subscribeRxEmbedded=function(b){var c='{"m":"srx"}';a.subscribed.rxembedded=1,a.sendMessage(c),void 0!=b?a.callbacks.rxembedded=b:a.callbacks.rxembedded=0},a.releaseRxEmbedded=function(){a.subscribed.rxembedded=0,a.sendMessage('{"m":"drx"}')},a.makeVibrate=function(b){var c;c=""!=b&&void 0!=b&&""!=b?'{"m":"makeVibrate","duration":"'+b+'"}':'{"m":"makeVibrate"}',a.sendMessage(c)},a.sendMessage=function(b){try{a.socket.send(b),a.retrial=0}catch(c){a.retrial<3?(a.socket.refresh(),a.retrial++,setTimeout(function(){a.sendMessage(b)},100)):console.warn("communication error: "+c)}},a};