function isNumber(e){return!isNaN(parseFloat(e))}function get_appropriate_ws_url(e){var t,n=document.URL;"https"==n.substring(0,5)?(t="wss://",n=n.substr(8)):(t="ws://","http"==n.substring(0,4)&&(n=n.substr(7))),n=n.split("/");var s="";return s=""==e?n[0]:e,t+s}function clamp(e,t,n){return t>e?e=t:e>n?e=n:e}var BrowserDetect={init:function(){this.browser=this.searchString(this.dataBrowser)||"An unknown browser",this.version=this.searchVersion(navigator.userAgent)||this.searchVersion(navigator.appVersion)||"an unknown version",this.OS=this.searchString(this.dataOS)||"an unknown OS"},searchString:function(e){for(var t=0;t<e.length;t++){var n=e[t].string,s=e[t].prop;if(this.versionSearchString=e[t].versionSearch||e[t].identity,n){if(-1!=n.indexOf(e[t].subString))return e[t].identity}else if(s)return e[t].identity}},searchVersion:function(e){var t=e.indexOf(this.versionSearchString);if(-1!=t)return parseFloat(e.substring(t+this.versionSearchString.length+1))},dataBrowser:[{string:navigator.userAgent,subString:"Chrome",identity:"Chrome"},{string:navigator.userAgent,subString:"OmniWeb",versionSearch:"OmniWeb/",identity:"OmniWeb"},{string:navigator.vendor,subString:"Apple",identity:"Safari",versionSearch:"Version"},{prop:window.opera,identity:"Opera",versionSearch:"Version"},{string:navigator.vendor,subString:"iCab",identity:"iCab"},{string:navigator.vendor,subString:"KDE",identity:"Konqueror"},{string:navigator.userAgent,subString:"Firefox",identity:"Firefox"},{string:navigator.vendor,subString:"Camino",identity:"Camino"},{string:navigator.userAgent,subString:"Netscape",identity:"Netscape"},{string:navigator.userAgent,subString:"MSIE",identity:"Explorer",versionSearch:"MSIE"},{string:navigator.userAgent,subString:"Gecko",identity:"Mozilla",versionSearch:"rv"},{string:navigator.userAgent,subString:"Mozilla",identity:"Netscape",versionSearch:"Mozilla"}],dataOS:[{string:navigator.platform,subString:"Win",identity:"Windows"},{string:navigator.platform,subString:"Mac",identity:"Mac"},{string:navigator.userAgent,subString:"iPhone",identity:"iPhone/iPod"},{string:navigator.platform,subString:"Linux",identity:"Linux"}]};BrowserDetect.init();var pos=0;String.prototype.replaceAll=function(e,t){var n=this;return n.replace(new RegExp(e,"g"),t)},!function(e,t){"function"==typeof define&&define.amd?define([],t):"undefined"!=typeof module&&module.exports?module.exports=t():e.ReconnectingWebSocket=t()}(this,function(){function e(t,n,s){function r(e,t){var n=document.createEvent("CustomEvent");return n.initCustomEvent(e,!1,!1,t),n}var i={debug:!1,automaticOpen:!0,reconnectInterval:1e3,maxReconnectInterval:3e4,reconnectDecay:1.5,timeoutInterval:2e3};s||(s={});for(var o in i)this[o]="undefined"!=typeof s[o]?s[o]:i[o];this.url=t,this.reconnectAttempts=0,this.readyState=WebSocket.CONNECTING,this.protocol=null;var a,c=this,g=!1,u=!1,d=document.createElement("div");d.addEventListener("open",function(e){c.onopen(e)}),d.addEventListener("close",function(e){c.onclose(e)}),d.addEventListener("connecting",function(e){c.onconnecting(e)}),d.addEventListener("message",function(e){c.onmessage(e)}),d.addEventListener("error",function(e){c.onerror(e)}),this.addEventListener=d.addEventListener.bind(d),this.removeEventListener=d.removeEventListener.bind(d),this.dispatchEvent=d.dispatchEvent.bind(d),this.open=function(t){a=new WebSocket(c.url,n||[]),t||d.dispatchEvent(r("connecting")),(c.debug||e.debugAll)&&console.debug("ReconnectingWebSocket","attempt-connect",c.url);var s=a,i=setTimeout(function(){(c.debug||e.debugAll)&&console.debug("ReconnectingWebSocket","connection-timeout",c.url),u=!0,s.close(),u=!1},c.timeoutInterval);a.onopen=function(){clearTimeout(i),(c.debug||e.debugAll)&&console.debug("ReconnectingWebSocket","onopen",c.url),c.protocol=a.protocol,c.readyState=WebSocket.OPEN,c.reconnectAttempts=0;var n=r("open");n.isReconnect=t,t=!1,d.dispatchEvent(n)},a.onclose=function(n){if(clearTimeout(i),a=null,g)c.readyState=WebSocket.CLOSED,d.dispatchEvent(r("close"));else{c.readyState=WebSocket.CONNECTING;var s=r("connecting");s.code=n.code,s.reason=n.reason,s.wasClean=n.wasClean,d.dispatchEvent(s),t||u||((c.debug||e.debugAll)&&console.debug("ReconnectingWebSocket","onclose",c.url),d.dispatchEvent(r("close")));var i=c.reconnectInterval*Math.pow(c.reconnectDecay,c.reconnectAttempts);setTimeout(function(){c.reconnectAttempts++,c.open(!0)},i>c.maxReconnectInterval?c.maxReconnectInterval:i)}},a.onmessage=function(t){(c.debug||e.debugAll)&&console.debug("ReconnectingWebSocket","onmessage",c.url,t.data);var n=r("message");n.data=t.data,d.dispatchEvent(n)},a.onerror=function(t){(c.debug||e.debugAll)&&console.debug("ReconnectingWebSocket","onerror",c.url,t),d.dispatchEvent(r("error"))}},1==this.automaticOpen&&this.open(!1),this.send=function(t){if(a)return(c.debug||e.debugAll)&&console.debug("ReconnectingWebSocket","send",c.url,t),a.send(t);throw"INVALID_STATE_ERR : Pausing to reconnect websocket"},this.close=function(e,t){"undefined"==typeof e&&(e=1e3),g=!0,a&&a.close(e,t)},this.refresh=function(){a&&a.close()}}return e.prototype.onopen=function(){},e.prototype.onclose=function(){},e.prototype.onconnecting=function(){},e.prototype.onmessage=function(){},e.prototype.onerror=function(){},e.debugAll=!1,e.CONNECTING=WebSocket.CONNECTING,e.OPEN=WebSocket.OPEN,e.CLOSING=WebSocket.CLOSING,e.CLOSED=WebSocket.CLOSED,e}),window.BFt={},BFt.state="INIT",BFt.changedStateInCycle=0,BFt.changeState=function(e){e!=BFt.state&&(BFt.state=e,BFt.changedStateInCycle=1,jQuery.event.trigger("stateChanged",{}))},window.onbeforeunload=function(){for(var e in BFt)BFt[e].socket.close(16,"page closing")},window.BFtObject=function(){var e=new Object;return e.socket=new Object,e.status="INIT",e.setupSocket=e.start=function(t){if(""==t)return void(t="192.168.1.:9092");-1==t.indexOf(":")&&(t+=":9092"),"Firefox"==BrowserDetect.browser?console.error("Websocket not supported. Please use Safari or Chrome."):e.socket=new ReconnectingWebSocket(get_appropriate_ws_url(t));try{e.socket.onopen=function(){e.status="OPEN",jQuery.event.trigger("socketOpened",[]),e.retrial=0;try{socketOpened()}catch(t){}},e.socket.onmessage=function(t){try{messageObject=JSON.parse(t.data)}catch(n){console.warn("error loading JSON",t,n)}var s=e.socket.url.replace(e.socket.url.slice(-5),"");if(s=s.slice(5),"x"==messageObject.m)return void jQuery.event.trigger("ping",{address:s});if(console.info('::: ----> received:"'+messageObject.m+'"',messageObject),"touched"!=messageObject.m)if("a"==messageObject.m)jQuery.event.trigger("a",{address:s,r:messageObject.r,y:messageObject.y,p:messageObject.p});else if("rx"==messageObject.m)jQuery.event.trigger("receivedRx",{address:s,v:messageObject.v});else if("orientationChanged"==messageObject.m){e.orientation=messageObject.value;try{orientationChanged(e.orientation)}catch(n){}jQuery.event.trigger("orientationChanged",{address:s,value:messageObject.value})}else if("magnetometerUpdate"==messageObject.m){e.magnetometer=messageObject.t,e.magnetometerIntensity=messageObject.i;try{magnetometerEvent(e.magnetometer,e.magnetometerIntensity)}catch(n){}jQuery.event.trigger("magnetometerEvent",{address:s,i:messageObject.i,t:messageObject.t})}else if("distanceChanged"==messageObject.m){e.proximity=messageObject.proximity;try{distanceEvent(e.proximity)}catch(n){}jQuery.event.trigger("distanceChanged",{address:s,p:messageObject.proximity})}else if("audioJackChanged"==messageObject.m){e.audiojack=messageObject["in"];try{distanceEvent(e.audiojack)}catch(n){}jQuery.event.trigger("audioJackChanged",{address:s,"in":messageObject["in"]})}else if("powerSourceChanged"==messageObject.m){e.powersource=messageObject.source;try{distanceEvent(e.powersource)}catch(n){}jQuery.event.trigger("powerSourceChanged",{address:s,"in":messageObject.source})}else if("batteryGet"==messageObject.m){e[boardNumReceived].batteryLevel=messageObject.value;try{gotBatteryLevel(messageObject.value)}catch(n){}}else"error"==messageObject.m?console.warn(messageObject.type):"test"==messageObject.m&&console.log(Date.now());else{0==messageObject.value||"0"==messageObject.value?e.touched=!1:(e.touched=!0,jQuery.event.trigger("touched",{address:s,x:messageObject.x,y:messageObject.y}));try{touched(s,messageObject.x,messageObject.y)}catch(n){}}},e.socket.onclose=function(){e.status="CLOSED",console.warn("connection: %s",e.status,e.socket)},e.socket.onerror=function(){e.status="ERROR"}}catch(n){alert("<p>Error"+n),e.status="ERROR"}},e.setServo=function(e,t){2==arguments.length&&this.sendMessage('{"m":"srv","n":'+e+',"v":'+t+"}")},e.setRelayEmbedded=function(e,t){2==arguments.length&&this.sendMessage('{"m":"rel","n":'+e+',"v":'+Math.round(t)+"}")},e.doTxEmbedded=function(e){1==arguments.length&&this.sendMessage('{"m":"tx","v":'+e+"}")},e.setColorEmbedded=function(e,t,n,s,r){5==arguments.length&&this.sendMessage('{"m":"col","n":"'+e+'","r":"'+Math.floor(t)+'","g":"'+Math.floor(n)+'","b":"'+Math.floor(s)+'","a":"'+Math.floor(r)+'"}')},e.setColor=function(e,t,n,s){4==arguments.length&&this.sendMessage('{"m":"setColor","r":"'+e+'","g":"'+t+'","b":"'+n+'","a":"'+s+'"}')},e.setLED=function(e){e>0&&1>=e?this.sendMessage('{"m":"setLED","value":"1","in":"'+e+'"}'):this.sendMessage('{"m":"setLED","value":"0"}')},e.pulseLED=function(e,t,n){3==arguments.length?this.sendMessage('{"m":"pulseLED","t":"'+e+'","d":"'+t+'","i":"'+n+'"}'):console.warn("pulseLED requires 3 inputs: numberOfPulses,duration,intensity")},e.showImage=function(e){"string"==typeof e?this.sendMessage('{"m":"showImage","url":"'+e+'"}'):console.warn("showImage requires a string input")},e.playVideo=function(e){"string"==typeof e?this.sendMessage('{"m":"playVideo","url":"'+e+'"}'):console.warn("playVideo requires a string input")},e.playAudio=function(e){"string"==typeof e?this.sendMessage('{"m":"playAudio","url":"'+e+'"}'):console.warn("playAudio requires a string input")},e.setBrightness=function(e){isNumber(e)?this.sendMessage('{"m":"setBrightness","b":"'+e+'"}'):console.warn("setBrighness requires one numerical parameter")},e.transitionColors=function(e,t,n){3==arguments.length?(isNumber(n)||(n=5,console.warn("transitionColors: duration is not a number")),this.sendMessage('{"m":"transitionColors","r1":"'+e.r+'","g1":"'+e.b+'","b1":"'+e.g+'","a1":"'+e.a+'","r2":"'+t.r+'","g2":"'+t.g+'","b2":"'+t.b+'","a2":"'+t.a+'","duration":"'+n+'"}')):console.warn("transitionColors requires 3 parameters: color1,color2,duration")},e.getBatteryLevel=function(){var e='{"m":"getBattery"}';this.sendMessage(e)},e.subscribeDistance=function(){this.sendMessage('{"m":"registerDistance"}')},e.releaseDistance=function(){this.sendMessage('{"m":"releaseDistance"}')},e.subscribeTouch=function(){this.touchRegistered=!0,this.sendMessage('{"m":"registerTouch"}')},e.releaseTouch=function(){this.touchRegistered=!1,this.sendMessage('{"m":"releaseTouch"}')},e.subscribeAttitude=function(e){this.attitudeRegistered=!0,this.sendMessage('{"m":"registerAttitude","f":"'+e+'"}')},e.releaseAttitude=function(e){this.attitudeRegistered=!1,this.sendMessage('{"m":"releaseAttitude"}')},e.subscribeAudioJack=function(){this.sendMessage('{"m":"registerAudioJack"}')},e.subscribePowerSource=function(){this.sendMessage('{"m":"registerPowerSource"}')},e.subscribeMagnetometer=function(){this.sendMessage('{"m":"registerMagnetometer"}')},e.releaseMagnetometer=function(){this.sendMessage('{"m":"releaseMagnetometer"}')},e.subscribeOrientation=function(){var t='{"m":"registerOrientation"}';e.orientationRegistered=!0,this.sendMessage(t)},e.releaseOrientation=function(){var t='{"m":"releaseOrientation"}';e.orientationRegistered=!1,this.sendMessage(t)},e.subscribeRxEmbedded=function(){var e='{"m":"srx"}';this.sendMessage(e)},e.releaseRxEmbedded=function(){this.sendMessage('{"m":"drx"}')},e.makeVibrate=function(e){var t;t=""!=e&&void 0!=e&&""!=e?'{"m":"makeVibrate","duration":"'+e+'"}':'{"m":"makeVibrate"}',this.sendMessage(t)},e.sendMessage=function(t){try{e.socket.send(t),e.retrial=0}catch(n){e.retrial<3?(e.socket.refresh(),e.retrial++,setTimeout(function(){e.sendMessage(t)},100)):console.warn("communication error: "+n)}},e};