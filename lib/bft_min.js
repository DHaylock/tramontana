function isNumber(e){return!isNaN(parseFloat(e))}function get_appropriate_ws_url(e){var n,t=document.URL;"https"==t.substring(0,5)?(n="wss://",t=t.substr(8)):(n="ws://","http"==t.substring(0,4)&&(t=t.substr(7))),t=t.split("/");var i="";return i=""==e?t[0]:e,n+i}function clamp(e,n,t){return n>e?e=n:e>t?e=t:e}var BrowserDetect={init:function(){this.browser=this.searchString(this.dataBrowser)||"An unknown browser",this.version=this.searchVersion(navigator.userAgent)||this.searchVersion(navigator.appVersion)||"an unknown version",this.OS=this.searchString(this.dataOS)||"an unknown OS"},searchString:function(e){for(var n=0;n<e.length;n++){var t=e[n].string,i=e[n].prop;if(this.versionSearchString=e[n].versionSearch||e[n].identity,t){if(-1!=t.indexOf(e[n].subString))return e[n].identity}else if(i)return e[n].identity}},searchVersion:function(e){var n=e.indexOf(this.versionSearchString);if(-1!=n)return parseFloat(e.substring(n+this.versionSearchString.length+1))},dataBrowser:[{string:navigator.userAgent,subString:"Chrome",identity:"Chrome"},{string:navigator.userAgent,subString:"OmniWeb",versionSearch:"OmniWeb/",identity:"OmniWeb"},{string:navigator.vendor,subString:"Apple",identity:"Safari",versionSearch:"Version"},{prop:window.opera,identity:"Opera",versionSearch:"Version"},{string:navigator.vendor,subString:"iCab",identity:"iCab"},{string:navigator.vendor,subString:"KDE",identity:"Konqueror"},{string:navigator.userAgent,subString:"Firefox",identity:"Firefox"},{string:navigator.vendor,subString:"Camino",identity:"Camino"},{string:navigator.userAgent,subString:"Netscape",identity:"Netscape"},{string:navigator.userAgent,subString:"MSIE",identity:"Explorer",versionSearch:"MSIE"},{string:navigator.userAgent,subString:"Gecko",identity:"Mozilla",versionSearch:"rv"},{string:navigator.userAgent,subString:"Mozilla",identity:"Netscape",versionSearch:"Mozilla"}],dataOS:[{string:navigator.platform,subString:"Win",identity:"Windows"},{string:navigator.platform,subString:"Mac",identity:"Mac"},{string:navigator.userAgent,subString:"iPhone",identity:"iPhone/iPod"},{string:navigator.platform,subString:"Linux",identity:"Linux"}]};BrowserDetect.init();var pos=0;String.prototype.replaceAll=function(e,n){var t=this;return t.replace(new RegExp(e,"g"),n)},!function(e,n){"function"==typeof define&&define.amd?define([],n):"undefined"!=typeof module&&module.exports?module.exports=n():e.ReconnectingWebSocket=n()}(this,function(){function e(n,t,i){function o(e,n){var t=document.createEvent("CustomEvent");return t.initCustomEvent(e,!1,!1,n),t}var r={debug:!1,automaticOpen:!0,reconnectInterval:1e3,maxReconnectInterval:3e4,reconnectDecay:1.5,timeoutInterval:2e3};i||(i={});for(var s in r)this[s]="undefined"!=typeof i[s]?i[s]:r[s];this.url=n,this.reconnectAttempts=0,this.readyState=WebSocket.CONNECTING,this.protocol=null;var c,a=this,u=!1,g=!1,d=document.createElement("div");d.addEventListener("open",function(e){a.onopen(e)}),d.addEventListener("close",function(e){a.onclose(e)}),d.addEventListener("connecting",function(e){a.onconnecting(e)}),d.addEventListener("message",function(e){a.onmessage(e)}),d.addEventListener("error",function(e){a.onerror(e)}),this.addEventListener=d.addEventListener.bind(d),this.removeEventListener=d.removeEventListener.bind(d),this.dispatchEvent=d.dispatchEvent.bind(d),this.open=function(n){c=new WebSocket(a.url,t||[]),n||d.dispatchEvent(o("connecting")),(a.debug||e.debugAll)&&console.debug("ReconnectingWebSocket","attempt-connect",a.url);var i=c,r=setTimeout(function(){(a.debug||e.debugAll)&&console.debug("ReconnectingWebSocket","connection-timeout",a.url),g=!0,i.close(),g=!1},a.timeoutInterval);c.onopen=function(){clearTimeout(r),(a.debug||e.debugAll)&&console.debug("ReconnectingWebSocket","onopen",a.url),a.protocol=c.protocol,a.readyState=WebSocket.OPEN,a.reconnectAttempts=0;var t=o("open");t.isReconnect=n,n=!1,d.dispatchEvent(t)},c.onclose=function(t){if(clearTimeout(r),c=null,u)a.readyState=WebSocket.CLOSED,d.dispatchEvent(o("close"));else{a.readyState=WebSocket.CONNECTING;var i=o("connecting");i.code=t.code,i.reason=t.reason,i.wasClean=t.wasClean,d.dispatchEvent(i),n||g||((a.debug||e.debugAll)&&console.debug("ReconnectingWebSocket","onclose",a.url),d.dispatchEvent(o("close")));var r=a.reconnectInterval*Math.pow(a.reconnectDecay,a.reconnectAttempts);setTimeout(function(){a.reconnectAttempts++,a.open(!0)},r>a.maxReconnectInterval?a.maxReconnectInterval:r)}},c.onmessage=function(n){(a.debug||e.debugAll)&&console.debug("ReconnectingWebSocket","onmessage",a.url,n.data);var t=o("message");t.data=n.data,d.dispatchEvent(t)},c.onerror=function(n){(a.debug||e.debugAll)&&console.debug("ReconnectingWebSocket","onerror",a.url,n),d.dispatchEvent(o("error"))}},1==this.automaticOpen&&this.open(!1),this.send=function(n){if(c)return(a.debug||e.debugAll)&&console.debug("ReconnectingWebSocket","send",a.url,n),c.send(n);throw"INVALID_STATE_ERR : Pausing to reconnect websocket"},this.close=function(e,n){"undefined"==typeof e&&(e=1e3),u=!0,c&&c.close(e,n)},this.refresh=function(){c&&c.close()}}return e.prototype.onopen=function(){},e.prototype.onclose=function(){},e.prototype.onconnecting=function(){},e.prototype.onmessage=function(){},e.prototype.onerror=function(){},e.debugAll=!1,e.CONNECTING=WebSocket.CONNECTING,e.OPEN=WebSocket.OPEN,e.CLOSING=WebSocket.CLOSING,e.CLOSED=WebSocket.CLOSED,e});window.BFt={},BFt.state="INIT",BFt.changedStateInCycle=0,BFt.changeState=function(e){e!=BFt.state&&(BFt.state=e,BFt.changedStateInCycle=1,jQuery.event.trigger("stateChanged",{}))},window.onbeforeunload=function(){for(var e in BFt)BFt[e].socket.close(16,"page closing")},window.BFtObject=function(){var e=new Object;return e.socket=new Object,e.status="INIT",e.subscribed={distance:0,orientation:0,attitude:0,magnetometer:0,touch:0,audiojack:0,powersource:0,rxembedded:0},e.subscribeFunctions={distance:0,orientation:0,attitude:0,magnetometer:0,touch:0,audiojack:0,powersource:0,rxembedded:0},e.setupSocket=e.start=function(s){if(""==s)return void(s="192.168.1.:9092");-1==s.indexOf(":")&&(s+=":9092"),"Firefox"==BrowserDetect.browser?console.error("Websocket not supported. Please use Safari or Chrome."):e.socket=new ReconnectingWebSocket(get_appropriate_ws_url(s));try{e.socket.onopen=function(){e.status="OPEN",jQuery.event.trigger("socketOpened",[]),e.retrial=0;for(var s in e.subscribed)e.subscribed[s]&&e.subscribeFunctions[s]();try{socketOpened()}catch(t){}},e.socket.onmessage=function(s){try{messageObject=JSON.parse(s.data)}catch(t){console.warn("error loading JSON",s,t)}var r=e.socket.url.replace(e.socket.url.slice(-5),"");if(r=r.slice(5),"x"==messageObject.m)return void jQuery.event.trigger("ping",{address:r});if(console.info('::: ----> received:"'+messageObject.m+'"',messageObject),"touched"!=messageObject.m)if("a"==messageObject.m)jQuery.event.trigger("a",{address:r,r:messageObject.r,y:messageObject.y,p:messageObject.p});else if("rx"==messageObject.m)jQuery.event.trigger("receivedRx",{address:r,v:messageObject.v});else if("orientationChanged"==messageObject.m){e.orientation=messageObject.value;try{orientationChanged(r,e.orientation)}catch(t){}jQuery.event.trigger("orientationChanged",{address:r,value:messageObject.value})}else if("magnetometerUpdate"==messageObject.m){e.magnetometer=messageObject.t,e.magnetometerIntensity=messageObject.i;try{magnetometerEvent(r,e.magnetometer,e.magnetometerIntensity)}catch(t){}jQuery.event.trigger("magnetometerEvent",{address:r,i:messageObject.i,t:messageObject.t})}else if("distanceChanged"==messageObject.m){e.proximity=messageObject.proximity;try{distanceChanged(r,e.proximity)}catch(t){}jQuery.event.trigger("distanceChanged",{address:r,p:messageObject.proximity})}else if("audioJackChanged"==messageObject.m){e.audiojack=messageObject["in"];try{audioJackChanged(r,e.audiojack)}catch(t){}jQuery.event.trigger("audioJackChanged",{address:r,"in":messageObject["in"]})}else if("powerSourceChanged"==messageObject.m){e.powersource=messageObject.source;try{powerSourceChanged(r,e.powersource)}catch(t){}jQuery.event.trigger("powerSourceChanged",{address:r,"in":messageObject.source})}else if("batteryGet"==messageObject.m){e[boardNumReceived].batteryLevel=messageObject.value;try{gotBatteryLevel(messageObject.value)}catch(t){}jQuery.event.trigger("gotBatteryLevel",{address:r,batteryLevel:messageObject.value})}else"error"==messageObject.m?console.warn(messageObject.type):"test"==messageObject.m&&console.log(Date.now());else{0==messageObject.value||"0"==messageObject.value?e.touched=!1:(e.touched=!0,jQuery.event.trigger("touched",{address:r,x:messageObject.x,y:messageObject.y}));try{touched(r,messageObject.x,messageObject.y)}catch(t){}}},e.socket.onclose=function(){e.status="CLOSED",console.warn("connection: %s",e.status,e.socket)},e.socket.onerror=function(){e.status="ERROR"}}catch(t){alert("<p>Error"+t),e.status="ERROR"}},e.setServoEmbedded=function(e,s){2==arguments.length&&this.sendMessage('{"m":"srv","n":'+e+',"v":'+s+"}")},e.setRelayEmbedded=function(e,s){2==arguments.length&&this.sendMessage('{"m":"rel","n":'+e+',"v":'+Math.round(s)+"}")},e.doTxEmbedded=function(e){1==arguments.length&&this.sendMessage('{"m":"tx","v":'+e+"}")},e.setColorEmbedded=function(e,s,t,r,n){5==arguments.length&&this.sendMessage('{"m":"col","n":"'+e+'","r":"'+Math.floor(s)+'","g":"'+Math.floor(t)+'","b":"'+Math.floor(r)+'","a":"'+Math.floor(n)+'"}')},e.setColor=function(e,s,t,n){if(4==arguments.length&&((e>1||s>1||t>1)&&(e/=255,s/=255,t/=255,n/=255),this.sendMessage('{"m":"setColor","r":"'+e+'","g":"'+s+'","b":"'+t+'","a":"'+n+'"}')),1==arguments.length&&arguments[0].hasOwnProperty(r)){var a=e;(a.r>1||a.g>1||a.b>1)&&(a.r=a.r/255,a.g=a.g/255,a.b=a.b/255,a.a=a.a/255),this.sendMessage('{"m":"setColor","r":"'+a.r+'","g":"'+a.g+'","b":"'+a.b+'","a":"'+a.a+'"}')}},e.setLED=function(e){this.sendMessage(e>0&&1>=e?'{"m":"setLED","value":"1","in":"'+e+'"}':'{"m":"setLED","value":"0"}')},e.pulseLED=function(e,s,t){3==arguments.length?this.sendMessage('{"m":"pulseLED","t":"'+e+'","d":"'+s+'","i":"'+t+'"}'):console.warn("pulseLED requires 3 inputs: numberOfPulses,duration,intensity")},e.showImage=function(e){"string"==typeof e?this.sendMessage('{"m":"showImage","url":"'+e+'"}'):console.warn("showImage requires a string input")},e.playVideo=function(e){"string"==typeof e?this.sendMessage('{"m":"playVideo","url":"'+e+'"}'):console.warn("playVideo requires a string input")},e.playAudio=function(e){"string"==typeof e?this.sendMessage('{"m":"playAudio","url":"'+e+'"}'):console.warn("playAudio requires a string input")},e.setBrightness=function(e){isNumber(e)?this.sendMessage('{"m":"setBrightness","b":"'+e+'"}'):console.warn("setBrighness requires one numerical parameter")},e.transitionColors=function(e,s,t){3==arguments.length?(isNumber(t)||(t=5,console.warn("transitionColors: duration is not a number")),this.sendMessage('{"m":"transitionColors","r1":"'+e.r+'","g1":"'+e.b+'","b1":"'+e.g+'","a1":"'+e.a+'","r2":"'+s.r+'","g2":"'+s.g+'","b2":"'+s.b+'","a2":"'+s.a+'","duration":"'+t+'"}')):console.warn("transitionColors requires 3 parameters: color1,color2,duration")},e.getBatteryLevel=function(){var s='{"m":"getBattery"}';e.sendMessage(s)},e.subscribeFunctions.distance=e.subscribeDistance=function(){e.subscribed.distance=1,e.sendMessage('{"m":"registerDistance"}')},e.releaseDistance=function(){e.subscribed.distance=0,e.sendMessage('{"m":"releaseDistance"}')},e.subscribeFunctions.touch=e.subscribeTouch=function(){e.subscribed.touch=1,e.sendMessage('{"m":"registerTouch"}')},e.releaseTouch=function(){e.subscribed.touch=0,e.sendMessage('{"m":"releaseTouch"}')},e.subscribeFunctions.attitude=e.subscribeAttitude=function(s){e.subscribed.attitude=1,e.sendMessage('{"m":"registerAttitude","f":"'+s+'"}')},e.releaseAttitude=function(){e.subscribed.attitude=0,e.sendMessage('{"m":"releaseAttitude"}')},e.subscribeFunctions.audiojack=e.subscribeAudioJack=function(){e.subscribed.audiojack=1,e.sendMessage('{"m":"registerAudioJack"}')},e.subscribeFunctions.powersource=e.subscribePowerSource=function(){e.subscribed.powersource=1,e.sendMessage('{"m":"registerPowerSource"}')},e.subscribeFunctions.magnetometer=e.subscribeMagnetometer=function(){e.subscribed.magnetometer=1,e.sendMessage('{"m":"registerMagnetometer"}')},e.releaseMagnetometer=function(){e.subscribed.magnetometer=0,e.sendMessage('{"m":"releaseMagnetometer"}')},e.subscribeFunctions.orientation=e.subscribeOrientation=function(){e.subscribed.orientation=1;var s='{"m":"registerOrientation"}';e.sendMessage(s)},e.releaseOrientation=function(){var s='{"m":"releaseOrientation"}';e.subscribed.orientation=0,e.sendMessage(s)},e.subscribeFunctions.rxembedded=e.subscribeRxEmbedded=function(){var s='{"m":"srx"}';e.subscribed.rxembedded=1,e.sendMessage(s)},e.releaseRxEmbedded=function(){e.subscribed.rxembedded=0,e.sendMessage('{"m":"drx"}')},e.makeVibrate=function(s){var t;t=""!=s&&void 0!=s&&""!=s?'{"m":"makeVibrate","duration":"'+s+'"}':'{"m":"makeVibrate"}',e.sendMessage(t)},e.sendMessage=function(s){try{e.socket.send(s),e.retrial=0}catch(t){e.retrial<3?(e.socket.refresh(),e.retrial++,setTimeout(function(){e.sendMessage(s)},100)):console.warn("communication error: "+t)}},e};