var BrowserDetect={init:function(){this.browser=this.searchString(this.dataBrowser)||"An unknown browser",this.version=this.searchVersion(navigator.userAgent)||this.searchVersion(navigator.appVersion)||"an unknown version",this.OS=this.searchString(this.dataOS)||"an unknown OS"},searchString:function(e){for(var t=0;t<e.length;t++){var n=e[t].string;var s=e[t].prop;if(this.versionSearchString=e[t].versionSearch||e[t].identity,n){if(-1!=n.indexOf(e[t].subString))return e[t].identity}else if(s)return e[t].identity}},searchVersion:function(e){var t=e.indexOf(this.versionSearchString);if(-1!=t)return parseFloat(e.substring(t+this.versionSearchString.length+1))},dataBrowser:[{string:navigator.userAgent,subString:"Chrome",identity:"Chrome"},{string:navigator.userAgent,subString:"OmniWeb",versionSearch:"OmniWeb/",identity:"OmniWeb"},{string:navigator.vendor,subString:"Apple",identity:"Safari",versionSearch:"Version"},{prop:window.opera,identity:"Opera",versionSearch:"Version"},{string:navigator.vendor,subString:"iCab",identity:"iCab"},{string:navigator.vendor,subString:"KDE",identity:"Konqueror"},{string:navigator.userAgent,subString:"Firefox",identity:"Firefox"},{string:navigator.vendor,subString:"Camino",identity:"Camino"},{string:navigator.userAgent,subString:"Netscape",identity:"Netscape"},{string:navigator.userAgent,subString:"MSIE",identity:"Explorer",versionSearch:"MSIE"},{string:navigator.userAgent,subString:"Gecko",identity:"Mozilla",versionSearch:"rv"},{string:navigator.userAgent,subString:"Mozilla",identity:"Netscape",versionSearch:"Mozilla"}],dataOS:[{string:navigator.platform,subString:"Win",identity:"Windows"},{string:navigator.platform,subString:"Mac",identity:"Mac"},{string:navigator.userAgent,subString:"iPhone",identity:"iPhone/iPod"},{string:navigator.platform,subString:"Linux",identity:"Linux"}]};BrowserDetect.init();var pos=0;String.prototype.replaceAll=function(e,t){var n=this;return n.replace(RegExp(e,"g"),t)};function isNumber(e){return!isNaN(parseFloat(e))}function get_appropriate_ws_url(e){var t;var n=document.URL;"https"==n.substring(0,5)?(t="wss://",n=n.substr(8)):(t="ws://","http"==n.substring(0,4)&&(n=n.substr(7))),n=n.split("/");var s="";return s=""==e?n[0]:e,t+s}function clamp(e,t,n){return t>e?e=t:e>n?e=n:e}!function(e,t){"function"==typeof define&&define.amd?define([],t):"undefined"!=typeof module&&module.exports?module.exports=t():e.ReconnectingWebSocket=t()}(this,function(){function e(t,n,s){function r(e,t){var n=document.createEvent("CustomEvent");return n.initCustomEvent(e,!1,!1,t),n}var o={debug:!1,automaticOpen:!0,reconnectInterval:1e3,maxReconnectInterval:3e4,reconnectDecay:1.5,timeoutInterval:2e3};s||(s={});for(var i in o)this[i]=void 0!==s[i]?s[i]:o[i];this.url=t,this.reconnectAttempts=0,this.readyState=WebSocket.CONNECTING,this.protocol=null;var a,c=this,u=!1,d=!1,g=document.createElement("div");g.addEventListener("open",function(e){c.onopen(e)}),g.addEventListener("close",function(e){c.onclose(e)}),g.addEventListener("connecting",function(e){c.onconnecting(e)}),g.addEventListener("message",function(e){c.onmessage(e)}),g.addEventListener("error",function(e){c.onerror(e)}),this.addEventListener=g.addEventListener.bind(g),this.removeEventListener=g.removeEventListener.bind(g),this.dispatchEvent=g.dispatchEvent.bind(g),this.open=function(t){a=new WebSocket(c.url,n||[]),t||g.dispatchEvent(r("connecting")),(c.debug||e.debugAll)&&console.debug("ReconnectingWebSocket","attempt-connect",c.url);var s=a,o=setTimeout(function(){(c.debug||e.debugAll)&&console.debug("ReconnectingWebSocket","connection-timeout",c.url),d=!0,s.close(),d=!1},c.timeoutInterval);a.onopen=function(){clearTimeout(o),(c.debug||e.debugAll)&&console.debug("ReconnectingWebSocket","onopen",c.url),c.protocol=a.protocol,c.readyState=WebSocket.OPEN,c.reconnectAttempts=0;var n=r("open");n.isReconnect=t,t=!1,g.dispatchEvent(n)},a.onclose=function(n){if(clearTimeout(o),a=null,u)c.readyState=WebSocket.CLOSED,g.dispatchEvent(r("close"));else{c.readyState=WebSocket.CONNECTING;var s=r("connecting");s.code=n.code,s.reason=n.reason,s.wasClean=n.wasClean,g.dispatchEvent(s),t||d||((c.debug||e.debugAll)&&console.debug("ReconnectingWebSocket","onclose",c.url),g.dispatchEvent(r("close")));var o=c.reconnectInterval*Math.pow(c.reconnectDecay,c.reconnectAttempts);setTimeout(function(){c.reconnectAttempts++,c.open(!0)},o>c.maxReconnectInterval?c.maxReconnectInterval:o)}},a.onmessage=function(t){(c.debug||e.debugAll)&&console.debug("ReconnectingWebSocket","onmessage",c.url,t.data);var n=r("message");n.data=t.data,g.dispatchEvent(n)},a.onerror=function(t){(c.debug||e.debugAll)&&console.debug("ReconnectingWebSocket","onerror",c.url,t),g.dispatchEvent(r("error"))}},1==this.automaticOpen&&this.open(!1),this.send=function(t){if(a)return(c.debug||e.debugAll)&&console.debug("ReconnectingWebSocket","send",c.url,t),a.send(t);throw"INVALID_STATE_ERR : Pausing to reconnect websocket"},this.close=function(e,t){void 0===e&&(e=1e3),u=!0,a&&a.close(e,t)},this.refresh=function(){a&&a.close()}}return e.prototype.onopen=function(){},e.prototype.onclose=function(){},e.prototype.onconnecting=function(){},e.prototype.onmessage=function(){},e.prototype.onerror=function(){},e.debugAll=!1,e.CONNECTING=WebSocket.CONNECTING,e.OPEN=WebSocket.OPEN,e.CLOSING=WebSocket.CLOSING,e.CLOSED=WebSocket.CLOSED,e}),window.BFt={},BFt.state="INIT",BFt.changedStateInCycle=0,BFt.changeState=function(e){e!=BFt.state&&(BFt.state=e,BFt.changedStateInCycle=1,jQuery.event.trigger("stateChanged",{}))},window.onbeforeunload=function(){for(var e in BFt)BFt[e].socket.close(16,"page closing")},window.BFtObject=function(){var e={};return e.socket={},e.status="INIT",e.subscribed={distance:0,orientation:0,attitude:0,magnetometer:0,touch:0,audiojack:0,powersource:0,rxembedded:0},e.callbacks={videoended:0,socketopen:0,distance:0,orientation:0,attitude:0,magnetometer:0,touch:0,audiojack:0,powersource:0,rxembedded:0},e.subscribeFunctions={distance:0,orientation:0,attitude:0,magnetometer:0,touch:0,audiojack:0,powersource:0,rxembedded:0},e.setupSocket=e.start=function(t,n){if(""==t)return void(t="192.168.1.:9092");-1==t.indexOf(":")&&(t+=":9092"),"Firefox"==BrowserDetect.browser?console.error("Websocket not supported. Please use Safari or Chrome."):e.socket=new ReconnectingWebSocket(get_appropriate_ws_url(t)),void 0!=n&&(e.callbacks.socketopen=n);try{e.socket.onopen=function(){e.status="OPEN",jQuery.event.trigger("socketOpened",[]),e.retrial=0;for(var t in e.subscribed)e.subscribed[t]&&e.subscribeFunctions[t]();0!=e.callbacks.socketopen&&e.callbacks.socketopen();try{socketOpened()}catch(n){}},e.socket.onmessage=function(t){try{messageObject=JSON.parse(t.data)}catch(n){console.warn("error loading JSON",t,n)}var s=e.socket.url.replace(e.socket.url.slice(-5),"");if(s=s.slice(5),"x"==messageObject["m"]||"xm"==messageObject["m"]||"xt"==messageObject["m"])return void jQuery.event.trigger("ping",{address:s,type:messageObject["m"]});if(console.info('::: ----> received:"'+messageObject["m"]+'"',messageObject),"touched"!=messageObject["m"])if("a"==messageObject["m"])jQuery.event.trigger("a",{address:s,r:messageObject["r"],y:messageObject["y"],p:messageObject["p"]}),0!=e.callbacks.attitude&&e.callbacks.attitude("receivedRx",{address:s,v:messageObject["v"]});else if("oom"==messageObject["m"])jQuery.event.trigger("oom",{address:s});else if("rx"==messageObject["m"])jQuery.event.trigger("receivedRx",{address:s,v:messageObject["v"]}),0!=e.callbacks.rxembedded&&e.callbacks.rxembedded("receivedRx",{address:s,v:messageObject["v"]});else if("orientationChanged"==messageObject["m"]){e.orientation=messageObject["value"],0!=e.callbacks.orientation&&e.callbacks.orientation(s,e.orientation);try{orientationChanged(s,e.orientation)}catch(n){}jQuery.event.trigger("orientationChanged",{address:s,value:messageObject["value"]})}else if("magnetometerUpdate"==messageObject["m"]){e.magnetometer=messageObject["t"],e.magnetometerIntensity=messageObject["i"],0!=e.callbacks.magnetometer&&e.callbacks.magnetometer(s,e.magnetometer,e.magnetometerIntensity);try{magnetometerEvent(s,e.magnetometer,e.magnetometerIntensity)}catch(n){}jQuery.event.trigger("magnetometerEvent",{address:s,i:messageObject["i"],t:messageObject["t"]})}else if("distanceChanged"==messageObject["m"]){e.proximity=messageObject["proximity"],0!=e.callbacks.distance&&e.callbacks.distance(s,e.proximity);try{distanceChanged(s,e.proximity)}catch(n){}jQuery.event.trigger("distanceChanged",{address:s,p:messageObject["proximity"]})}else if("audioJackChanged"==messageObject["m"]){e.audiojack=messageObject["in"],0!=e.callbacks.audiojack&&e.callbacks.audiojack(s,e.audiojack);try{audioJackChanged(s,e.audiojack)}catch(n){}jQuery.event.trigger("audioJackChanged",{address:s,"in":messageObject["in"]})}else if("powerSourceChanged"==messageObject["m"]){e.powersource=messageObject["source"],0!=e.callbacks.powersource&&e.callbacks.powersource(s,e.powersource);try{powerSourceChanged(s,e.powersource)}catch(n){}jQuery.event.trigger("powerSourceChanged",{address:s,"in":messageObject["source"]})}else if("batteryGet"==messageObject["m"]){e.batteryLevel=messageObject["value"];try{gotBatteryLevel(messageObject["value"])}catch(n){}jQuery.event.trigger("gotBatteryLevel",{address:s,batteryLevel:messageObject["value"]})}else if("videoEnded"==messageObject["m"]){0!=e.callbacks.videoended&&e.callbacks.videoended("videoEnded",{address:s});try{videoEnded()}catch(n){}jQuery.event.trigger("videoEnded",{address:s})}else"error"==messageObject["m"]?console.warn(messageObject["type"]):"test"==messageObject["m"]&&console.log(Date.now());else{(0==messageObject["value"]||"0"==messageObject["value"])&&(e.touched=!1),0!=e.callbacks.touched?e.callbacks.touched("touched",{address:s,x:messageObject["x"],y:messageObject["y"]}):(e.touched=!0,jQuery.event.trigger("touched",{address:s,x:messageObject["x"],y:messageObject["y"]}));try{touched(s,messageObject["x"],messageObject["y"])}catch(n){}}},e.socket.onclose=function(){e.status="CLOSED",console.warn("connection: %s",e.status,e.socket)},e.socket.onerror=function(){e.status="ERROR"}}catch(s){alert("<p>Error"+s),e.status="ERROR"}},e.setServoEmbedded=function(e,t){2==arguments.length&&this.sendMessage('{"m":"srv","n":'+e+',"v":'+t+"}")},e.setRelayEmbedded=function(e,t){2==arguments.length&&this.sendMessage('{"m":"rel","n":'+e+',"v":'+Math.round(t)+"}")},e.sendSerialMessageEmbedded=function(e){1==arguments.length&&this.sendMessage('{"m":"tx","v":"'+e+'"}')},e.setColorEmbedded=function(e,t,n,s){(5==arguments.length||4==arguments.length)&&this.sendMessage('{"m":"col","n":"'+e+'","r":"'+Math.floor(t)+'","g":"'+Math.floor(n)+'","b":"'+Math.floor(s)+'"}')},e.blinkColorEmbedded=function(e,t,n,s){4==arguments.length&&this.sendMessage('{"m":"blk","n":"'+e+'","r":"'+Math.floor(t)+'","g":"'+Math.floor(n)+'","b":"'+Math.floor(s)+'"}')},e.setAllColorEmbedded=function(e,t,n){4==arguments.length&&this.sendMessage('{"m":"all","r":"'+Math.floor(e)+'","g":"'+Math.floor(t)+'","b":"'+Math.floor(n)+'"}')},e.setColor=function(e,t,n,s){if(4==arguments.length&&((e>1||t>1||n>1)&&(e/=255,t/=255,n/=255,s/=255),this.sendMessage('{"m":"setColor","r":"'+e+'","g":"'+t+'","b":"'+n+'","a":"'+s+'"}')),1==arguments.length&&arguments[0].hasOwnProperty(r)){var o=e;(o.r>1||o.g>1||o.b>1)&&(o.r=o.r/255,o.g=o.g/255,o.b=o.b/255,o.a=o.a/255),this.sendMessage('{"m":"setColor","r":"'+o.r+'","g":"'+o.g+'","b":"'+o.b+'","a":"'+o.a+'"}')}},e.setFlashLight=function(e){e=clamp(e,0,e),this.sendMessage('{"m":"setLED","value":"1","in":"'+e+'"}')},e.pulseFlashLight=function(e,t,n){3==arguments.length?this.sendMessage('{"m":"pulseLED","t":"'+e+'","d":"'+t+'","i":"'+n+'"}'):console.warn("pulseLED requires 3 inputs: numberOfPulses,duration,intensity")},e.showImage=function(e){"string"==typeof e?this.sendMessage('{"m":"showImage","url":"'+e+'"}'):console.warn("showImage requires a string input")},e.playVideo=function(t,n){e.callbacks.videoended=void 0!=n?n:0,"string"==typeof t?this.sendMessage('{"m":"playVideo","url":"'+t+'"}'):console.warn("playVideo requires a string input")},e.playAudio=function(e){"string"==typeof e?this.sendMessage('{"m":"playAudio","url":"'+e+'"}'):console.warn("playAudio requires a string input")},e.setBrightness=function(e){isNumber(e)?this.sendMessage('{"m":"setBrightness","b":"'+e+'"}'):console.warn("setBrighness requires one numerical parameter")},e.takePicture=function(e,t){if(arguments.length>0&&isNumber(e)){var n='{"m":"takePicture","c":"'+e+'"';arguments.length>1&&"ui"==t&&(n+=',"i":"ui"'),n+="}",this.sendMessage(n)}else this.sendMessage('{"m":"takePicture"}')},e.transitionColors=function(e,t,n){3==arguments.length?(isNumber(n)||(n=5,console.warn("transitionColors: duration is not a number")),this.sendMessage('{"m":"transitionColors","r1":"'+e.r+'","g1":"'+e.b+'","b1":"'+e.g+'","a1":"'+e.a+'","r2":"'+t.r+'","g2":"'+t.g+'","b2":"'+t.b+'","a2":"'+t.a+'","duration":"'+n+'"}')):console.warn("transitionColors requires 3 parameters: color1,color2,duration")},e.getBatteryLevel=function(){var t='{"m":"getBattery"}';e.sendMessage(t)},e.subscribeFunctions.distance=e.subscribeDistance=function(t){e.subscribed.distance=1,e.sendMessage('{"m":"registerDistance"}'),e.callbacks.distance=void 0!=t?t:0},e.releaseDistance=function(){e.subscribed.distance=0,e.sendMessage('{"m":"releaseDistance"}')},e.subscribeFunctions.touch=e.subscribeTouch=function(t){e.subscribed.touch=1,e.sendMessage('{"m":"registerTouch"}'),e.callbacks.touch=void 0!=t?t:0},e.releaseTouch=function(){e.subscribed.touch=0,e.sendMessage('{"m":"releaseTouch"}')},e.subscribeFunctions.attitude=e.subscribeAttitude=function(t,n){e.subscribed.attitude=1,e.sendMessage('{"m":"registerAttitude","f":"'+t+'"}'),e.callbacks.attitude=void 0!=n?n:0},e.releaseAttitude=function(){e.subscribed.attitude=0,e.sendMessage('{"m":"releaseAttitude"}')},e.subscribeFunctions.audiojack=e.subscribeAudioJack=function(t){e.subscribed.audiojack=1,e.sendMessage('{"m":"registerAudioJack"}'),e.callbacks.audiojack=void 0!=t?t:0},e.releaseAudioJack(),e.subscribed.audiojack=0,e.sendMessage('{"m":"releaseAudioJack"}'),e.subscribeFunctions.powersource=e.subscribePowerSource=function(t){e.subscribed.powersource=1,e.sendMessage('{"m":"registerPowerSource"}'),e.callbacks.powersource=void 0!=t?t:0},e.releasePowerSource(),e.subscribed.powersource=0,e.sendMessage('{"m":"releasePowerSource"}'),e.subscribeFunctions.magnetometer=e.subscribeMagnetometer=function(t){e.subscribed.magnetometer=1,e.sendMessage('{"m":"registerMagnetometer"}'),e.callbacks.magnetometer=void 0!=t?t:0},e.releaseMagnetometer=function(){e.subscribed.magnetometer=0,e.sendMessage('{"m":"releaseMagnetometer"}')},e.subscribeFunctions.orientation=e.subscribeOrientation=function(t){e.subscribed.orientation=1;var n='{"m":"registerOrientation"}';e.sendMessage(n),e.callbacks.orientation=void 0!=t?t:0},e.releaseOrientation=function(){var t='{"m":"releaseOrientation"}';e.subscribed.orientation=0,e.sendMessage(t)},e.subscribeFunctions.rxembedded=e.subscribeRxEmbedded=function(t){var n='{"m":"srx"}';e.subscribed.rxembedded=1,e.sendMessage(n),e.callbacks.rxembedded=void 0!=t?t:0},e.releaseRxEmbedded=function(){e.subscribed.rxembedded=0,e.sendMessage('{"m":"drx"}')},e.makeVibrate=function(t){var n;n=""!=t&&void 0!=t&&""!=t?'{"m":"makeVibrate","duration":"'+t+'"}':'{"m":"makeVibrate"}',e.sendMessage(n)},e.sendMessage=function(t){try{e.socket.send(t),e.retrial=0}catch(n){e.retrial<3?(e.socket.refresh(),e.retrial++,setTimeout(function(){e.sendMessage(t)},100)):console.warn("communication error: "+n)}},e};